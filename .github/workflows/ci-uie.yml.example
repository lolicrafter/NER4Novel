name: CI with UIE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-uie:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ¨¡å‹ä¸‹è½½è¶…æ—¶
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-uie-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Cache UIE model
      uses: actions/cache@v4
      with:
        path: ~/.paddlenlp
        key: ${{ runner.os }}-uie-tiny-model-v1
        restore-keys: |
          ${{ runner.os }}-uie-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-wqy-zenhei fonts-wqy-microhei || echo "Font installation failed"
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install paddlenlp>=2.5.0 pandas>=1.3.0 openpyxl>=3.0.0
        pip install tqdm numpy networkx matplotlib
    
    - name: Test UIE script syntax
      run: |
        python -m py_compile rel_uie.py
        echo "âœ… ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
    
    - name: Test UIE extraction (small sample)
      env:
        CI: true
        UIE_MODEL: uie-tiny  # åœ¨ CI ä¸­ä½¿ç”¨è½»é‡çº§æ¨¡å‹
        MPLBACKEND: Agg
      run: |
        mkdir -p output
        echo "ğŸ“š æ£€æŸ¥æµ‹è¯•ä¹¦ç±..."
        ls -la book/ 2>/dev/null || echo "book/ ç›®å½•ä¸å­˜åœ¨"
        
        # æŸ¥æ‰¾æµ‹è¯•ä¹¦ç±
        BOOK_FILE=$(find book -maxdepth 1 -name "*.txt" -type f | head -n 1)
        
        if [ -n "$BOOK_FILE" ] && [ -f "$BOOK_FILE" ]; then
          BOOK_NAME=$(basename "$BOOK_FILE" .txt)
          echo "âœ… æ‰¾åˆ°æµ‹è¯•ä¹¦ç±: $BOOK_NAME"
          echo "ğŸš€ å¼€å§‹ UIE æµ‹è¯•ï¼ˆä½¿ç”¨è½»é‡çº§æ¨¡å‹ï¼‰..."
          
          # ä½¿ç”¨è¾ƒå°çš„å‚æ•°ï¼Œé¿å…è¶…æ—¶
          python rel_uie.py \
            --book "$BOOK_NAME" \
            --batch_size 8 \
            --max_length 256 \
            --output output || {
            echo "âš ï¸ UIE æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½æ˜¯æ¨¡å‹ä¸‹è½½è¶…æ—¶æˆ–èµ„æºä¸è¶³ï¼‰"
            echo "ğŸ’¡ è¿™æ˜¯æ­£å¸¸çš„ï¼ŒUIE æ¨¡å‹è¾ƒå¤§ï¼Œåœ¨ CI ä¸­å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´"
            exit 0  # å…è®¸å¤±è´¥ï¼Œä¸é˜»å¡ CI
          }
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•ä¹¦ç±ï¼Œè·³è¿‡ UIE å®é™…è¿è¡Œæµ‹è¯•"
          echo "ğŸ’¡ ä»…è¿›è¡Œè¯­æ³•æ£€æŸ¥"
        fi
      continue-on-error: true  # å…è®¸å¤±è´¥ï¼Œå› ä¸ºæ¨¡å‹ä¸‹è½½å¯èƒ½è¶…æ—¶
    
    - name: Upload UIE results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: uie-test-results
        path: output/
        if-no-files-found: warn
        retention-days: 7
      continue-on-error: true

